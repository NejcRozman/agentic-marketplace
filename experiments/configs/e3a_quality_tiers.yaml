# E3a Quality Tiers with Reputation
# Research Question: RQ2, RQ3 - Quality differentiation with reputation-weighted selection
# Description: 50 auctions with 3 quality tiers (high/medium/low), reputation weight=25%

experiment:
  id: "e3a_quality_tiers"
  name: "Quality Tiers with Reputation"
  description: |
    Tests market mechanism with heterogeneous quality providers using ERC-8004 reputation.
    9 providers in 3 quality tiers (3 high, 3 medium, 3 low), consumer uses reputation_weight=25%.
  research_question: "RQ2, RQ3"
  duration_timeout: 21600  # Maximum 6 hours for entire experiment

blockchain:
  network: "anvil"
  rpc_url: "http://localhost:8545"
  fork_network: "sepolia"  # Fork from Sepolia to get ERC-8004 contracts
  infura_key_env: "INFURA_API_KEY"  # Read from environment
  
  contracts:
    # Addresses of contracts (deployed by experiment or pre-existing)
    reverse_auction: null  # null = deploy new
    identity_registry: "0x8004a6090Cd10A7288092483047B097295Fb8847"  # Sepolia ERC-8004
    reputation_registry: "0x8004B8FD1A363aa02fDC07635C0c5F94f6Af5B7E"  # Sepolia ERC-8004
    payment_token: null  # null = deploy mock USDC
    
  accounts:
    main_account: "${BLOCKCHAIN_PRIVATE_KEY}"
    deployer: "${BLOCKCHAIN_PRIVATE_KEY}"
    consumer: "${BLOCKCHAIN_CONSUMER_PRIVATE_KEY}"
    providers:
      - "${BLOCKCHAIN_PRIVATE_KEY}"  # Only need 1 key, experiment runner generates others
    
    # Funding configuration for consumer account
    consumer_funding:
      eth_amount: 2000000000000000000  # 2 ETH in wei
      usdc_amount: 5000000000  # 5000 USDC (6 decimals) - 50 auctions Ã— 100 USDC

agents:
  consumer:
    count: 1
    agent_id: null  # null = register new agent
    private_key: null  # null = use blockchain.accounts.consumer
    
    config:
      check_interval: 5  # Check blockchain every 5 seconds
      max_budget: 100000000  # 100 USDC per auction (with 6 decimals)
      auction_duration: 60  # 1 minute per auction
      reputation_weight: 25  # 0-100: weight of reputation vs price (25 = 25% reputation, 75% price)
      
    behavior:
      pdf_directory: "utils/files"  # Use existing test PDFs
      service_selection: "sequential"  # Use PDFs in order
      service_complexity: "medium"
      auto_create_auction: true  # Create auction immediately on start
      num_auctions: 50  # Create 50 sequential auctions
      auto_monitor: true  # Monitor auction automatically
      inter_auction_delay: 5  # Wait 5 seconds between auctions
      eligible_per_auction: 5  # Randomly select 5 providers per auction (heterogeneous exposure)
      
  providers:
    count: 9  # Create 9 provider agents (3 per quality tier)
    agent_ids: [null, null, null, null, null, null, null, null, null]  # null = register new agents
    private_keys: null  # null = use blockchain.accounts.providers
    
    # Quality profile configuration - defines quality tier for each provider
    # High quality: temp=0, k=5, chunk=8000, overlap=400, detailed prompt, base_cost=60 USDC
    # Medium quality: temp=0.3, k=3, chunk=10000, overlap=200, standard prompt, base_cost=40 USDC
    # Low quality: temp=0.7, k=1, chunk=15000, overlap=0, minimal prompt, base_cost=20 USDC
    quality_profiles: ["high", "high", "high", "medium", "medium", "medium", "low", "low", "low"]
    
    config:
      check_interval: 5  # Check blockchain every 5 seconds
      
    behavior:
      strategy: "honest"  # All providers use honest quality and competitive bidding
      auto_bid: true  # Automatically bid on detected auctions
      auto_execute: true  # Automatically execute won services
      auto_complete: true  # Automatically complete on blockchain
     
experiment_flow:
  phases:
    - name: "setup"
      description: "Start Anvil, deploy contracts, register agents, mint USDC"
      timeout: 60  # 1 minute to set up blockchain
      
    - name: "agents_start"
      description: "Launch consumer and provider agents with quality profiles"
      timeout: 30  # 30 seconds for agents to initialize
      
    - name: "experiment_run"
      description: "Agents operate autonomously until 50 auctions completed"
      stopping_criteria:
        type: "completed_auctions"  # Poll consumer.get_status()['completed_auctions']
        poll_interval: 5  # Check every 5 seconds
        
  # Reputation tracking configuration
  reputation_snapshots:
    enabled: true  # Take reputation snapshots after each auction
    after_feedback: true  # Snapshot after feedback is submitted
    include_all_providers: true  # Include all providers, not just winners
  
monitoring:
  metrics:
    - auction_created  # Did consumer create auction successfully?
    - bids_received  # How many providers bid?
    - winner_selected  # Which provider won?
    - service_completed  # Did winner complete service?
    - feedback_submitted  # Did consumer submit feedback?
    - reputation_updated  # Was reputation updated on-chain?
    - quality_by_tier  # Track quality ratings per tier
    - win_distribution  # Track wins per tier over time
    - cost_by_tier  # Track costs paid per tier
